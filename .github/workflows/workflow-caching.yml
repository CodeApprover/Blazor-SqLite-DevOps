---
name: "Cache Dependencies"

on:
  repository_dispatch:
    types: trigger-dotnet-prep

jobs:
  prepare-dotnet:
    runs-on: ubuntu-latest

    steps:

    - name: Report SHA and Workflow Timestamp
      run: |
        echo "Received SHA: ${{ github.event.client_payload.sha }}"
        date

    - name: Checkout Repository
      uses: actions/checkout@v3.5.3
      with:
        ref: ${{ github.event.client_payload.sha }}

    - name: Check csproj Existence
      run: |
        if [[ ! -f ${{ github.event.client_payload.csproj }} ]]; then
          echo "Error: .csproj file not found at path: ${{ github.event.client_payload.csproj }}"
          exit 1
        fi

    - name: Restore Dependencies
      run: |
        echo "Restoring .NET dependencies for ${{ github.event.client_payload.csproj }}"
        dotnet restore ${{ github.event.client_payload.csproj }}

    # Cache .NET dependencies for faster subsequent workflow runs
    - name: Cache dotnet Dependencies
      id: cache-dotnet-restore
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-dotnet-${{ github.event.client_payload.sha }}
        restore-keys: |
          ${{ runner.os }}-dotnet-

    - name: Trigger Stylecop Workflow # Applies to all commits
      run: |
        # Make curl request to trigger next workflow, sending payload
        CMD="curl -X POST -H \"Authorization: Bearer ${{ secrets.AUTH }}\" "
        CMD+="-H \"Accept: application/vnd.github.everest-preview+json\" "
        CMD+="https://api.github.com/repos/${{ github.repository }}/dispatches "
        CMD+="--data '{\"event_type\": \"trigger-dotnet-prep\", "
        CMD+="\"client_payload\": {\"csproj\": \"${{ github.event.client_payload.csproj }}\", "
        CMD+="\"sha\": \"${{ github.event.client_payload.sha }}\"}}'"

        eval ${CMD} || { echo "Failed to trigger .NET Prep workflow"; exit 1; }
