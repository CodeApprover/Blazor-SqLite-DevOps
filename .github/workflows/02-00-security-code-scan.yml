######################################
# Workflow: Security Code Scan

# Description:
# This workflow performs a security code scan on the application codebase. 
# It ensures the integrity and security of the code by running a series of checks 
# and validations. The results are then uploaded for further review and action.

# Trigger: Activated by completion of the "Authentication Gate" workflow and scheduled runs.

# Logical Flow (Steps):
# 1. Checkout the repository.
# 2. Setup the required NuGet packages.
# 3. Prepare MSBuild.
# 4. Add the security code scanning action.
# 5. Setup the .NET environment.
# 6. Retrieve cached .NET dependencies.
# 7. Restore .NET dependencies if not cached.
# 8. Build the .NET application.
# 9. Convert security scan results to the sarif format.
# 10. Upload sarif results to GitHub.

# Exit Codes:
# 34 - Dotnet restore failed.
# 35 - Dotnet build failed.

######################################

---
name: SecurityCodeScan

on:
  workflow_run:
    workflows: ["Authentication Gate"]
    types: [completed]
    branches-ignore:
      - 'code-development'
  schedule:
    - cron: '37 9 * * 2,5'

env:
  SHA: ${{ github.event.client_payload.sha }}
  SHA_BRANCH: ${{ github.event.client_payload.sha_branch }}
  CSPROJ: ${{ github.event.client_payload.csproj }}

jobs:
  SCS:
    name: Security Code Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Repository # Step 1
        uses: actions/checkout@v3.6.0

      - name: Setup NuGet Packages # Step 2
        uses: nuget/setup-nuget@v1.2.0

      - name: Prepare MSBuild # Step 3
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Add Security Code Scanning Action # Step 4
        uses: security-code-scan/security-code-scan-add-action@v1.2

      - name: Setup .NET Environment # Step 5
        uses: actions/setup-dotnet@v3.2.0
        with:
          dotnet-version: "7.0.x"

      - name: Retrieve Cached .NET Dependencies # Step 6
        id: cache-dotnet-restore
        uses: actions/cache@v3.3.1
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-dotnet-${{ env.SHA }}
          restore-keys: |
            ${{ runner.os }}-dotnet-

      - name: Restore .NET Dependencies # Step 7
        run: |
          if [ "${{ steps.cache-dotnet-restore.outputs.cache-hit }}" != 'true' ]; then
            dotnet restore --no-cache "$CSPROJ" || (echo "##[error] Dotnet restore failed" && exit 34)
          fi

      - name: Build .NET Application # Step 8
        run: dotnet build --no-restore $CSPROJ || (echo "##[error] Dotnet build failed" && exit 35)

      - name: Convert Security Scan Results to Sarif # Step 9
        uses: security-code-scan/security-code-scan-results-action@v1.3

      - name: Upload Sarif Results to GitHub # Step 10
        uses: github/codeql-action/upload-sarif@v2
