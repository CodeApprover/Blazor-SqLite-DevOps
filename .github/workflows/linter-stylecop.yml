---
name: "StyleCop"
on:
  repository_dispatch:
    types: report_dispatch

env:
  BASE_PATH: "${{ github.workspace }}"
  PROJ_NAME: "Blazor SqlLite Golf Club"

jobs:

  get-branch-name:
    name: Get Branch Name
    runs-on: ubuntu-latest

    steps:

    - name: Set Branch Name
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.client_payload.ref }}

    - name: Get branch name for SHA
      id: get_branch
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.AUTH }}
        script: |
          const { sha } = context.eventPayload.client_payload;
          const branches = await github.repos.listBranchesForHeadCommit({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: sha
          });
          if (branches.data.length > 0) {
            return branches.data[0].name;
          } else {
            throw new Error(`No branches found for commit ${sha}`);
          }

    - name: Set BRANCH_NAME environment variable
      run: echo "BRANCH_NAME=${{ steps.get_branch.outputs.result }}" >> $GITHUB_ENV

    - name: Verify Branch Name
      run: |
        if [[ -z "${{ env.BRANCH_NAME }}" ]]; then 
          exit 1
        fi

  stylecop-linting:
    name: StyleCop Linting
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3.5.3

    - name: Set CSPROJ path
      run: |
        CSPROJ="${{ env.BASE_PATH }}/$BRANCH_NAME/"
        CSPROJ+="${{ env.PROJ_NAME }}/${{ env.PROJ_NAME }}.csproj"
        echo "CSPROJ=$CSPROJ" >> $GITHUB_ENV

    - name: Setup .NET environment
      uses: actions/setup-dotnet@v3.2.0
      with:
        dotnet-version: '7.0.x'

    - name: Restore Dependencies
      run: |
        echo "CSPROJ == $CSPROJ"
        dotnet restore --no-cache "$CSPROJ"

    - name: Dotnet Build
      run: |
        CMD="dotnet build --no-restore \"$CSPROJ\""
        CMD+=" /p:StyleCopEnabled=true"
        CMD+=" /p:StyleCopTreatErrorsAsWarnings=false"
        CMD+=" /p:StyleCopForceFullAnalysis=false"
        eval "$CMD"
