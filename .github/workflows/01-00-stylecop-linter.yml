---
name: StyleCop Linter

# ${{ github.workflow }} Overview
#
# This workflow lints code using StyleCop, ensuring code quality and consistency.
#
# The stylecop-lintier job has 3 main phases:
# 1. Setup and Environment Restoration: This phase pulls the repository, sets up the required .NET environment
#    and retrieves cached .NET dependencies if available.
# 2. Dependency Restoration and Build: If the cache doesn't contain the dependencies, they are restored.
#    The code is then built with StyleCop enabled, treating errors with severity and conducting a selective analysis.
# 3. Trigger Subsequent Workflow: Upon successful linting and build, the next workflow (Development-Tests, 
#    Staging-Tests, or Production-Tests) is initiated depending on the branch.
#
# Exit Codes:
#
# 34 - Dependency restoration failed.
# 35 - Dotnet .NET build with StyleCop failed.
# 90 - Failed to trigger the next workflow after exhausting retries.


on:
  repository_dispatch:
    types: StyleCop Linter

env:
  SHA: ${{ github.event.client_payload.sha }}
  CSPROJ: ${{ github.event.client_payload.csproj }}

jobs:

  stylecop-linter:

    name: StyleCop Linter
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # un-comment to block execution
    #if: (github.actor != ${{ github.repository_owner }})

    steps:

    - name: Checkout SHA Repository
      id: checkout
      uses: actions/checkout@v3.6.0
      with:
        ref: ${{ env.SHA }}
        fetch-depth: 0

    - name: Setup .NET Environment
      uses: actions/setup-dotnet@v3.2.0
      with:
        dotnet-version: '7.0.x'

    - name: Retrieve Cached dotnet Dependencies
      id: cache-dotnet-restore
      uses: actions/cache/restore@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-dotnet-${{ env.SHA }}
        restore-keys: ${{ runner.os }}-dotnet-

    - name: Restore Dependencies
      if: steps.cache-dotnet-restore.outputs.cache-hit != 'true'
      run: dotnet restore --no-cache "${{ env.CSPROJ }}" -v detailed || (echo "##[error] Dotnet restore failed" && exit 34)

    - name: Dotnet Build with StyleCop
      run: |
        CMD="dotnet build --no-restore \"${{ env.CSPROJ }}\" "
        CMD+="-v detailed "
        CMD+="/p:StyleCopEnabled=true "
        CMD+="/p:StyleCopTreatErrorsAsWarnings=false "
        CMD+="/p:StyleCopForceFullAnalysis=false"
        eval "$CMD" || (echo "##[error] Dotnet build failed" && exit 35)

    - name: Trigger Next Workflow # Development-Tests | Staging-Tests | Production-Tests
      if: success()
      run: |
        branch=$(git branch --contains ${{ env.SHA }})
        case "$branch" in
          code-development) trigger="Development Tests" ;;
          code-staging) trigger="Staging Tests" ;;
          code-production) trigger="Production Tests" ;;
          main) trigger="Production Tests" ;;
        esac
        echo "##[info] Calling $trigger"

        CMD="curl -L -X POST "
        CMD+="-H \"Accept: application/vnd.github+json\" "
        CMD+="-H \"Authorization: Bearer ${{ secrets.AUTH }}\" "
        CMD+="-H \"X-GitHub-Api-Version: 2022-11-28\" "
        CMD+="https://api.github.com/repos/${{ github.repository }}/dispatches "
        CMD+="-d '{\"event_type\":\"$trigger\","
        CMD+="\"client_payload\":{"
        CMD+="\"sha\":\"${{ github.sha }}\","
        CMD+="\"csproj\":\"${{ env.CSPROJ }}\"}'"

        retries=0
        while [[ $retries -lt ${{ vars.MAX_RETRIES }} ]]; do
            eval "$CMD"
            CURL_EXIT_CODE=$?
            if [[ $CURL_EXIT_CODE -ne 0 ]]; then
                echo "##[error] Curl command failed on attempt $((retries+1)) with exit code $CURL_EXIT_CODE"
                retries=$((retries+1))
                if [[ $retries -lt ${{ vars.MAX_RETRIES }} ]]; then
                    echo "##[warn] Retrying in ${{ vars.WAIT_SECONDS }} seconds..."
                    sleep ${{ vars.WAIT_SECONDS }}
                else
                    echo "##[error] Exhausted ${{ vars.MAX_RETRIES }} retries at ${{ vars.WAIT_SECONDS }} intervals."
                    echo "##[error] Failed to trigger $trigger workflow with CURL command: $CMD." && exit 90
                fi
            else
                break # successful curl
            fi    
        done
        echo "##[debug] CURL command: $CMD"
