name: Test Success

on:
  repository_dispatch:
    types: trigger-test-success

env:
  PROJ_NAME: "Blazor-SqLite-Golf-Club"
  DOCKER_REPO: "blazor-sqlite-devops"

jobs:
  save-docker-image:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:

    - name: Checkout SHA repository
      uses: actions/checkout@v3.5.3
      with:
        ref: ${{ github.event.client_payload.sha }}
        fetch-depth: 0

    - name: Log in to Docker Hub
      uses: docker/login-action@v2.2.0
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_PASSWORD }}

    - name: Check for .lock file
      run: |
        if [[ -e ".lock" ]]; then
          echo "Found .lock file! Deployments are locked! Exiting."
          exit 1
        fi

    - name: Enable Docker Experimental Features
      run: |
        echo '{ "experimental": true }' | sudo tee /etc/docker/daemon.json
        sudo systemctl restart docker
        docker version

    - name: Extract Branch Name from SHA Commit
      run: |
        branch=$(git branch -r --contains ${{ github.event.client_payload.sha }} | sed -n 's#^ *origin/##p' | head -n 1)
        if [[ -z "$branch" ]]; then
          echo "Failed to extract branch name for SHA: ${{ github.event.client_payload.sha }}"
          exit 1
        fi
        echo "BRANCH_NAME=$branch" >> $GITHUB_ENV

    - name: Set Environment Name
      run: |
        envirn=$(echo "${{ env.BRANCH_NAME }}" | sed 's/^code-//')
        echo "ENV_NAME=$envirn" >> $GITHUB_ENV
    
    
    - name: Increment version
      run: |
        echo "VERSION=$(head -n 1 $(find ./${{ env.ENV_NAME }} -name "version" | head -n 1))" >> $GITHUB_ENV
        # Source the env variables to make sure we have access to VERSION
        source $GITHUB_ENV
        PRODUCTION=$(echo "$VERSION" | cut -d'.' -f1)
        STAGING=$(echo "$VERSION" | cut -d'.' -f2)
        DEVELOPMENT=$(echo "$VERSION" | cut -d'.' -f3)
        
        case "$ENV_NAME" in
          "production")
            PRODUCTION=$((PRODUCTION + 1))
            ;;
          "staging")
            STAGING=$((STAGING + 1))
            ;;
          "development")
            DEVELOPMENT=$((DEVELOPMENT + 1))
            ;;
        esac
        
        NEW_VERSION="$PRODUCTION.$STAGING.$DEVELOPMENT"
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
       
    - name: Check if Docker image already exists
      run: |
        if docker manifest inspect ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_REPO }}:v${{ env.NEW_VERSION }} > /dev/null; then
          echo "Docker image already exists! Exiting."
          exit 1
        fi

    - name: Set .csproj path
      run: |
        CSPROJ=$(find "${{ github.workspace }}/${{ env.ENV_NAME }}" -name "${{ env.PROJ_NAME }}.csproj")
        if [[ ! -f "$CSPROJ" ]]; then
          echo "csproj not found"
          exit 1
        fi
        echo "CSPROJ=$CSPROJ" >> $GITHUB_ENV
    
    - name: Build and push Docker image
      run: |
        docker_file=$(find ./${{ env.ENV_NAME }} -name "Dockerfile" | head -n 1)
        if [[ ! -f "$docker_file" ]]; then
          echo "Dockerfile not found"
          exit 1
        fi
        cd ${{ github.workspace }}/${{ env.ENV_NAME }}"/${{ env.PROJ_NAME }}/
        ls ./* 
        docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_REPO }}:v${{ env.NEW_VERSION }} -f "${docker_file}" "${{ github.workspace }}"
        docker push ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_REPO }}:v${{ env.NEW_VERSION }}"

    - name: Write version to file
      run: |
        echo "${NEW_VERSION}" > $(find ./${{ env.ENV_NAME }} -name "version" | head -n 1)    

  deploy-to-environment:

    needs: save-docker-image
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:

      - uses: github/branch-deploy@v7.2.0
        id: branch-deploy
        with:
          trigger: ".deploy"

      - name: Checkout SHA repository
        uses: actions/checkout@v3.5.3
        with:
          ref: ${{ github.event.client_payload.sha }}
          fetch-depth: 0

      - name: Determine Deploy Branch and Directory
        run: |
          branch=$(git branch -r --contains ${{ github.event.client_payload.sha }} | sed -n 's#^ *origin/##p' | head -n 1)
          deploy_branch="Invalid"
          deploy_dir="."
          case "${branch}" in
            "code-development")
              deploy_branch="code-staging"
              deploy_dir="./code-development-in"
              ;;
            "code-staging")
              deploy_branch="code-production"
              deploy_dir="./code-production-in"
              ;;
            "code-production")
              deploy_branch="main"
              deploy_dir="."
              ;;
          esac
          [[ "$deploy_branch" == "Invalid" ]] && echo "Invalid deployment branch $deploy_branch." && exit 1
          echo "DEPLOY_BRANCH=$deploy_branch" >> $GITHUB_ENV
          echo "DEPLOY_DIR=$deploy_dir" >> $GITHUB_ENV
          echo "BRANCH_NAME=$branch" >> $GITHUB_ENV

      - name: Deploy
        if: steps.branch-deploy.outputs.continue == 'true'
        uses: nicholasgriffintn/github-branch-deployment-action@0.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.AUTH }}
          BRANCH: ${{ env.DEPLOY_BRANCH }}
          FOLDER: ${{ env.DEPLOY_DIR }}
          MESSAGE: 'Deploy: ({sha}) {msg}'

      - name: Notification
        if: steps.branch-deploy.outputs.continue == 'true'
        run: echo "Deployed ${{ github.event.client_payload.sha }} from ${{ env.BRANCH_NAME }} to ${{ env.DEPLOY_BRANCH }}"
