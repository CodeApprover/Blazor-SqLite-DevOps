name: Deployment Success

on:
  repository_dispatch:
    types: Deployment Success

env:
  SHA: ${{ github.event.client_payload.sha }}
  SHA_BRANCH: ${{ github.event.client_payload.sha_branch }}
  CSPROJ: ${{ github.event.client_payload.csproj }}
  GH_TOKEN: ${{ secrets.AUTH }}

jobs:
  deployment-success:
    name: Deployment Success
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout SHA Repository
        uses: actions/checkout@v3.6.0
        with:
          ref: ${{ env.SHA }}
          fetch-depth: 0

      - name: Set DevOps Environment
        run: |
          
          branch=${{ env.SHA_BRANCH }}
          directory=${branch/code-/}
          if [[ "$environment" == "development" ]]; then
              branch="code-staging"
          elif [[ "$environment" == "staging" ]]; then
              branch="code-production"
          elif [[ "$environment" == "production" ]]; then
              branch="main"
          elif [[ "$environment" == "main" ]]; then
              branch="main"
              directory="production"
          fi
          echo "DEPLOY_BRANCH=$branch" >> $GITHUB_ENV
          echo "DIRECTORY=$directory" >> $GITHUB_ENV

      - name: Update Deployment Status
        run: |

          latest_tag=$(git tag -l 'v*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1) # v1.2.3 SemVer
          desc="Deploying SHA ${{ env.SHA }} from ${{ env.SHA_BRANCH }} based on tag $latest_tag."

          CMD_STATUS=$(echo "curl -L -X POST" \
                       "-H 'Authorization: Bearer ${{ secrets.AUTH }}'" \
                       "-H 'Accept: application/vnd.github.v3+json'" \
                       "https://api.github.com/repos/${{ github.repository }}/statuses/${{ env.SHA }}" \
                       "-d '{\"state\": \"success\"," \
                       "\"description\": \"$desc\"," \
                       "\"context\": \"deployment/${{ env.SHA_BRANCH }}\"}'")

          RESPONSE_STATUS=$(eval "$CMD_STATUS")
          echo "##[debug] Status API Response: $RESPONSE_STATUS"

          CMD_DEPLOY=$(echo "gh api --method POST" \
                       "-H 'Accept: application/vnd.github+json' -H 'X-GitHub-Api-Version: 2022-11-28'" \
                       "/repos/${{ github.repository }}/deployments" \
                       "-f ref='${{ env.SHA_BRANCH }}'" \
                       "-f payload='{\"action\": \"deploy\", \"target_branch\": \"${{ env.SHA_BRANCH }}\"}'" \
                       "-f description='$desc'")

          RESPONSE_DEPLOY=$(eval "$CMD_DEPLOY")
          echo "##[debug] Deployment API Response: $RESPONSE_DEPLOY"
