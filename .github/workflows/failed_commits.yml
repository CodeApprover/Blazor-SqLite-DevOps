name: Reject on Failure

on:
  workflow_run:
    workflows:
      - StyleCop
      - CodeQL
      - SuperLinter
    types:
      - completed

jobs:
  revert_on_failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3.5.3
      with:
        token: ${{ secrets.AUTH }}
        ref: ${{ github.event.workflow_run.head_sha }} # the commit

    - name: Revert Commit
      run: |
        git reset --hard HEAD~1
        git push origin +${{ github.head_ref }}

    - name: Notify Committer
      run: |
        curl \
        -X POST \
        -H "Authorization: token ${{ secrets.PAT }}" \
        -H "Accept: application/vnd.github.v3+json" \
        https://api.github.com/repos/${{ github.repository }}/commits/${{ github.event.workflow_run.head_sha }}/comments \
        -d '{"body":"Linting failed on your commit and it has been automatically rejected. Please check and fix the linting errors before pushing again."}'
   
