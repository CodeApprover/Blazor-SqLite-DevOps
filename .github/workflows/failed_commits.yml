name: Failure

on:
  workflow_run:
    workflows:
      - StyleCop
      - CodeQL
      - SuperLinter
    types:
      - completed

jobs:
  revert-commit:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
  
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.workflow_run.head_sha }}
        fetch-depth: 0 # get entire history

    - name: Extract branch name
      run: echo "BRANCH_NAME=$(echo ${{ github.ref }} | grep -oE '[^/]+$')" >> $GITHUB_ENV

    - name: Switch to target branch
      run: git checkout ${BRANCH_NAME}
      env:
        BRANCH_NAME: ${{ env.BRANCH_NAME }}

    - name: Set git user
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

    - name: Revert the failed commit
      run: git revert ${{ github.event.workflow_run.head_sha }} --no-edit

    - name: Push the revert commit
      run: git push https://${GH_PAT}:x-oauth-basic@github.com/CodeApprover/Blazor-SqLite-DevOps.git ${BRANCH_NAME}
      env:
        BRANCH_NAME: ${{ env.BRANCH_NAME }}
        GH_PAT: ${{ secrets.AUTH }}

    - name: Notify Committer
      run: |
        COMMITTER=$(git log -1 --pretty=format:'%an')
        WORKFLOW_LINK="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        COMMENT_BODY="Hello @$COMMITTER, your recent commit ${{ github.event.workflow_run.head_sha }} "
        COMMENT_BODY+="has failed and has been automatically reverted. "
        COMMENT_BODY+="Please check the [workflow run]($WORKFLOW_LINK) for details, "
        COMMENT_BODY+="address any issues and try pushing again. Thank you!"
        
        CURL_CMD="curl -X POST"
        CURL_CMD+=" -H \"Authorization: token ${{ secrets.AUTH }}\""
        CURL_CMD+=" -H \"Accept: application/vnd.github.v3+json\""
        CURL_CMD+=" https://api.github.com/repos/${{ github.repository }}/commits/${{ github.event.workflow_run.head_sha }}/comments"
        CURL_CMD+=" -d \"{\\\"body\\\":\\\"$COMMENT_BODY\\\"}\""
        eval "$CURL_CMD"
