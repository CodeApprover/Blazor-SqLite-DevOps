---
name: "Cache Dependencies"

on:
  repository_dispatch:
    types: trigger-cache-dependencies

jobs:
  prepare-dotnet:
    runs-on: ubuntu-latest

    steps:

    - name: Report SHA and Workflow Timestamp
      run: |
        echo "Received SHA: ${{ github.event.client_payload.sha }}"
        date

    - name: Checkout Repository
      uses: actions/checkout@v3.5.3
      with:
        ref: ${{ github.event.client_payload.sha }}

    - name: Check csproj Existence
      run: |
        if [[ ! -f ${{ github.event.client_payload.csproj }} ]]; then
          echo "Error: .csproj file not found at path: ${{ github.event.client_payload.csproj }}"
          exit 1
        fi

    - name: Restore Dependencies
      run: |
        echo "Restoring .NET dependencies for ${{ github.event.client_payload.csproj }}"
        dotnet restore ${{ github.event.client_payload.csproj }}

    # Cache .NET dependencies for faster subsequent workflow runs
    - name: Cache dotnet Dependencies
      id: cache-dotnet-restore
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-dotnet-${{ github.event.client_payload.sha }}
        restore-keys: |
          ${{ runner.os }}-dotnet-

    - name: Trigger Stylecop Workflow # linter-stylecop.yml
      run: |
        BASE="{\"event_type\": \"trigger-stylecop-linting\", \"client_payload\": {"
        CSPROJ="\"csproj\": \"${{ github.event.client_payload.csproj }}\","
        SHA="\"sha\": \"${{ github.event.client_payload.sha }}\""
        END="}}"
        PAYLOAD="$BASE$CSPROJ$SHA$END"
    
        CMD="curl -s -o /dev/null -w \"%{http_code}\" -X POST "
        CMD+="-H \"Authorization: Bearer ${{ secrets.AUTH }}\" "
        CMD+="-H \"Accept: application/vnd.github.v3+json\" "
        CMD+="-d '$PAYLOAD' "
        CMD+="https://api.github.com/repos/${{ github.repository }}/dispatches"
        RESPONSE=$(eval "$CMD")
    
        # Check for failure (non-200 status codes)
        if [[ "$RESPONSE" -ne 200 ]]; then
            echo "##[error] Failed to trigger Stylecop Workflow. HTTP Code: $RESPONSE"
            exit 1
        else
            echo "##[debug] Successfully Triggered Stylecop Workflow for ${{ github.event.client_payload.sha }}."
        fi

