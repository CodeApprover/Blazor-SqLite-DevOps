---
name: "Cache Dependencies"

# Caches reusables e.g. nuget packages

# Exit Codes
# 1: Curl command to trigger next workflow failed

on:
  repository_dispatch:
    types: trigger-cache-dependencies

env:
  # Pre-validated
  SHA: ${{ github.event.client_payload.sha }}
  SHA_BRANCH: ${{ github.event.client_payload.branch_name }}
  CSPROJ: ${{ github.event.client_payload.csproj }}

jobs:

  prepare-dotnet:
    name: Cache Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: (github.actor != 'CodeApprover')

    steps:

    - name: Checkout SHA Repository
      uses: actions/checkout@v3.5.3
      with:
        ref: ${{ env.SHA }}
        fetch-depth: 0

    - name: Report
      run: |
        echo "##[debug] Checking initial state"
        date
        echo "SHA=${{ env.SHA }}"
        echo "Environment=${{ env.SHA_BRANCH }}"
        echo "Branch=${{ env.SHA_BRANCH }}"
        echo "Committer=$(git log -1 --pretty=format:'%an')"

    - name: Restore Dependencies
      run: |
        echo "Restoring .NET dependencies for ${{ env.CSPROJ }}"
        dotnet restore ${{ env.CSPROJ }}

    - name: Cache dotnet Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-dotnet-${{ env.SHA }}
        restore-keys: |
          ${{ runner.os }}-dotnet-

    - name: Set default job status
      run: echo "JOB_STATUS=success" >> $GITHUB_ENV

    - name: Set failure status if any step failed
      run: |
        echo "##[error] Failed detected in previous steps"
        echo "JOB_STATUS=failure" >> $GITHUB_ENV
      if: failure()

    - name: Trigger Next Workflow # 02-stylecop-linter.yml
      run: |
        trigger="trigger-stylecop-linter"
        BASE="{\"event_type\": \"$trigger\", \"client_payload\": {"
        SHA="\"sha\": \"${{ env.SHA }}\","
        CSPROJ="\"csproj\": \"${{ env.CSPROJ }}\","
        BRANCH="\"branch_name\": \"${{ env.SHA_BRANCH }}\""
        END="}}"
        PAYLOAD="$BASE$SHA$CSPROJ$BRANCH$END"

        CMD=(curl -s -o /dev/null -w "%{http_code}" -X POST 
        -H "Authorization: Bearer ${{ secrets.AUTH }}"
        -H "Accept: application/vnd.github.v3+json"
        -d "$PAYLOAD"
        "https://api.github.com/repos/${{ github.repository }}/dispatches")
        RESPONSE=$("${CMD[@]}")

        if [[ $RESPONSE -ge 200 && $RESPONSE -le 206 ]]; then  # HTTP 'success'
          echo "##[error] Failed to trigger next workflow. HTTP Code: $RESPONSE"
          echo "##[error] $trigger"
          exit 1
        else
          echo "##[debug] Triggered next workflow=$trigger"
        fi
